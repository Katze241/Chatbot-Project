from google.colab import files
from PIL import ImageFilter, ImageEnhance
import zipfile
import xml.etree.ElementTree as ET
import pytesseract
import io

uploaded = files.upload()
hwpx_path = list(uploaded.keys())[0]

def preprocess_image(img):
    img = img.convert("L")
    img = img.resize((int(img.width * 2), int(img.height * 2)))
    img = img.filter(ImageFilter.MedianFilter(size=3))
    enhancer = ImageEnhance.Contrast(img)
    img = enhancer.enhance(2.0)
    img = img.point(lambda x: 0 if x < 140 else 255, '1')
    return img.convert("RGB")

def extract_text_hwpx(hwpx_path):
    all_text = []
    with zipfile.ZipFile(hwpx_path, 'r') as zipf:
        if "Contents/section0.xml" not in zipf.namelist():
            print("Error")
            return ""

        xml_data = zipf.read("Contents/section0.xml")
        root = ET.fromstring(xml_data)
        ns = {'h': 'http://www.hancom.co.kr/hwpml/2010'}

        for elem in root.iter():
            tag = elem.tag.split('}')[-1]
            if tag == 'p':  # 단락 텍스트
                text = ''.join(t for t in elem.itertext()).strip()
                if text:
                    all_text.append(text)
            elif tag == 'tbl':  # 표 텍스트
                all_text.append("[표 시작]")
                for tr in elem.findall('h:tr', ns):
                    row_cells = []
                    for tc in tr.findall('h:tc', ns):
                        cell_text = ''.join(t for t in tc.itertext()).strip()
                        row_cells.append(cell_text)
                    all_text.append(' | '.join(row_cells))
                all_text.append("[표 끝]")

        # 이미지(미완성)
        image_files = [f for f in zipf.namelist() if f.startswith("Resources/Images/") and f.lower().endswith((".png", ".jpeg", ".jpg"))]

        for image_file in image_files:
            image_data = zipf.read(image_file)
            img = Image.open(io.BytesIO(image_data))
            preprocessed_img = preprocess_image(img)
            ocr_text = pytesseract.image_to_string(preprocessed_img, lang="kor+eng", config="--oem 3 --psm 6")
            if ocr_text.strip():
                all_text.append(f"[이미지 OCR: {image_file}]")
                all_text.append(ocr_text.strip())

    return "\n".join(all_text)

text = extract_text_hwpx(hwpx_path)
print("추출된 텍스트:\n")
print(text)
